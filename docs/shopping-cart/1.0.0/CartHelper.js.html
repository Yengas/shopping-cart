<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>CartHelper.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="CampaignHandler.html">CampaignHandler</a><ul class='methods'><li data-type='method'><a href="CampaignHandler.html#getDiscount">getDiscount</a></li></ul></li><li><a href="DefaultCampaignHandler.html">DefaultCampaignHandler</a><ul class='methods'><li data-type='method'><a href="DefaultCampaignHandler.html#getDiscount">getDiscount</a></li></ul></li><li><a href="Cart.html">Cart</a><ul class='methods'><li data-type='method'><a href="Cart.html#addItem">addItem</a></li><li data-type='method'><a href="Cart.html#removeItem">removeItem</a></li></ul></li><li><a href="CartHelper.html">CartHelper</a><ul class='methods'><li data-type='method'><a href="CartHelper.html#pickBestCampaign">pickBestCampaign</a></li><li data-type='method'><a href="CartHelper.html#finalizeCart">finalizeCart</a></li><li data-type='method'><a href="CartHelper.html#doesCampaignApplyForCart">doesCampaignApplyForCart</a></li><li data-type='method'><a href="CartHelper.html#doesCouponApplyForCart">doesCouponApplyForCart</a></li><li data-type='method'><a href="CartHelper.html#.createDefault">createDefault</a></li></ul></li><li><a href="CouponHandler.html">CouponHandler</a><ul class='methods'><li data-type='method'><a href="CouponHandler.html#getDiscount">getDiscount</a></li></ul></li><li><a href="DefaultCouponHandler.html">DefaultCouponHandler</a><ul class='methods'><li data-type='method'><a href="DefaultCouponHandler.html#getDiscount">getDiscount</a></li></ul></li><li><a href="DeliveryCostCalculator.html">DeliveryCostCalculator</a><ul class='methods'><li data-type='method'><a href="DeliveryCostCalculator.html#calculateFor">calculateFor</a></li></ul></li><li><a href="DiscountApplier.html">DiscountApplier</a><ul class='methods'><li data-type='method'><a href="DiscountApplier.html#applyDiscount">applyDiscount</a></li></ul></li><li><a href="DiscountRateApplier.html">DiscountRateApplier</a><ul class='methods'><li data-type='method'><a href="DiscountRateApplier.html#applyDiscount">applyDiscount</a></li></ul></li><li><a href="DiscountAmountApplier.html">DiscountAmountApplier</a><ul class='methods'><li data-type='method'><a href="DiscountAmountApplier.html#applyDiscount">applyDiscount</a></li></ul></li><li><a href="CategoryDAO.html">CategoryDAO</a><ul class='methods'><li data-type='method'><a href="CategoryDAO.html#insert">insert</a></li><li data-type='method'><a href="CategoryDAO.html#replace">replace</a></li><li data-type='method'><a href="CategoryDAO.html#getForId">getForId</a></li></ul></li><li><a href="DataAccessObject.html">DataAccessObject</a><ul class='methods'><li data-type='method'><a href="DataAccessObject.html#insert">insert</a></li><li data-type='method'><a href="DataAccessObject.html#replace">replace</a></li><li data-type='method'><a href="DataAccessObject.html#getForId">getForId</a></li></ul></li><li><a href="ProductDAO.html">ProductDAO</a><ul class='methods'><li data-type='method'><a href="ProductDAO.html#insert">insert</a></li><li data-type='method'><a href="ProductDAO.html#replace">replace</a></li><li data-type='method'><a href="ProductDAO.html#getForId">getForId</a></li></ul></li><li><a href="ShoppingCartError.html">ShoppingCartError</a></li><li><a href="Campaign.html">Campaign</a><ul class='methods'><li data-type='method'><a href="Campaign.html#equals">equals</a></li></ul></li><li><a href="CartProduct.html">CartProduct</a><ul class='methods'><li data-type='method'><a href="CartProduct.html#productEquals">productEquals</a></li></ul></li><li><a href="Category.html">Category</a><ul class='methods'><li data-type='method'><a href="Category.html#withId">withId</a></li><li data-type='method'><a href="Category.html#equals">equals</a></li></ul></li><li><a href="Coupon.html">Coupon</a><ul class='methods'><li data-type='method'><a href="Coupon.html#equals">equals</a></li></ul></li><li><a href="FinalizedCart.html">FinalizedCart</a></li><li><a href="Product.html">Product</a><ul class='methods'><li data-type='method'><a href="Product.html#withId">withId</a></li><li data-type='method'><a href="Product.html#equals">equals</a></li></ul></li></ul><h3>Global</h3><ul><li><a href="global.html#getTotalPriceForCategory">getTotalPriceForCategory</a></li><li><a href="global.html#removeProductFromCartProducts">removeProductFromCartProducts</a></li><li><a href="global.html#findCartProduct">findCartProduct</a></li><li><a href="global.html#getProductCountInCart">getProductCountInCart</a></li><li><a href="global.html#getCartPricesByCategory">getCartPricesByCategory</a></li><li><a href="global.html#applyCampaignToCart">applyCampaignToCart</a></li><li><a href="global.html#applyCouponToAmount">applyCouponToAmount</a></li><li><a href="global.html#getDistinctCategoriesFromCartProducts">getDistinctCategoriesFromCartProducts</a></li><li><a href="global.html#insertToDAO">insertToDAO</a></li><li><a href="global.html#convertIndexToId">convertIndexToId</a></li><li><a href="global.html#convertIdToIndex">convertIdToIndex</a></li><li><a href="global.html#DiscountType">DiscountType</a></li><li><a href="global.html#isString">isString</a></li><li><a href="global.html#isNonEmptyString">isNonEmptyString</a></li><li><a href="global.html#isMaybeOfType">isMaybeOfType</a></li><li><a href="global.html#isNumber">isNumber</a></li><li><a href="global.html#isNonNegativeNumber">isNonNegativeNumber</a></li><li><a href="global.html#isNonNegativeInteger">isNonNegativeInteger</a></li><li><a href="global.html#isEnum">isEnum</a></li><li><a href="global.html#isId">isId</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">CartHelper.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const CampaignHandler = require('./CampaignHandler');
const CouponHandler = require('./CouponHandler');
const DeliveryCostCalculator = require('./DeliveryCostCalculator');
const FinalizedCart = require('./models/FinalizedCart');

const sumArr = arr => arr.reduce((acc, v) => acc + v, 0);

/**
 * Given a list of cart products, return how much was spent on each category.
 * Returns a map of category id to, amount spent in that category.
 * @param cartProducts
 */
const getCartPricesByCategory = cartProducts => (
  cartProducts
    .reduce(
      (acc, { count, product: { price, category } }) => ({
        [category.id]: (
          category.id in acc ? acc[category.id] : 0
        ) + (price * count),
      }),
      {},
    )
);
/**
 * Apply the given discount to the cart
 * @param {CampaignHandler} campaignHandler
 * @param {Cart} cart
 * @param amountSpentByCategory
 * @param {Campaign} campaign
 * @returns {{ amountSpentByCategory: *, campaignDiscountAmount: number }}
 */
const applyCampaignToCart = (campaignHandler, cart, amountSpentByCategory, campaign) => {
  const campaignDiscountAmount = (
    campaign === null
      ? null
      : campaignHandler.getDiscount(cart, campaign)
  );
  if (campaignDiscountAmount === null) return { amountSpentByCategory, campaignDiscountAmount: 0 };

  return {
    amountSpentByCategory: {
      ...amountSpentByCategory,
      [campaignDiscountAmount.categoryId]: campaignDiscountAmount.discountedPrice,
    },
    campaignDiscountAmount: (
      amountSpentByCategory[campaignDiscountAmount.categoryId]
      - campaignDiscountAmount.discountedPrice
    ),
  };
};
/**
 * Apply the given coupon to the cart
 * @param {CouponHandler} couponHandler
 * @param {Number} totalPrice
 * @param {Coupon} coupon
 * @returns {{ finalAmount: Number, couponDiscountAmount: number }}
 */
const applyCouponToAmount = (couponHandler, totalPrice, coupon) => {
  const couponDiscountAmount = (
    coupon === null
      ? null
      : couponHandler.getDiscount(totalPrice, coupon)
  );
  if (couponDiscountAmount === null) return { finalAmount: totalPrice, couponDiscountAmount: 0 };

  return {
    finalAmount: couponDiscountAmount.discountedPrice,
    couponDiscountAmount: totalPrice - couponDiscountAmount.discountedPrice,
  };
};

/**
 * CartHelper is a class that includes functions to create finalized carts,
 * and utility functions like picking the best campaign.
 */
class CartHelper {
  /**
   * Requirements of the cart helper to run related logic
   * @param {CampaignHandler} campaignHandler
   * @param {CouponHandler} couponHandler
   * @param {DeliveryCostCalculator} deliveryCostCalculator
   */
  constructor(campaignHandler, couponHandler, deliveryCostCalculator) {
    this.campaignHandler = campaignHandler;
    this.couponHandler = couponHandler;
    this.deliveryCostCalculator = deliveryCostCalculator;
  }

  /**
   * Get the best campaign to apply to the cart, according to the most discounted amount.
   * Returns null if none of the campaigns can be applied
   * @param {Cart} cart
   * @param {Campaign} campaigns
   * @returns {Campaign|null}
   */
  pickBestCampaign(cart, ...campaigns) {
    const result = campaigns.reduce((acc, campaign) => {
      const campaignDiscount = this.campaignHandler.getDiscount(cart, campaign);
      if (campaignDiscount === null) return acc;
      if (acc === null) return { discount: campaignDiscount, campaign };
      const { discount } = acc;

      // if this campaign supplies more discount, return this
      if (campaignDiscount.discountedPrice &lt; discount.discountedPrice) {
        return { discount: campaignDiscount, campaignDiscount };
      }

      return acc;
    }, null);

    return result !== null ? result.campaign : null;
  }

  /**
   * Create the finalized cart with all of the discounted prices calculated.
   * @param {Cart} cart
   * @param {Campaign} campaign
   * @param {Coupon} coupon
   * @returns {FinalizedCart}
   */
  finalizeCart(cart, campaign, coupon) {
    // calculate campaign discount and money paid by category
    const spentCategoryMap = getCartPricesByCategory(cart.products);
    const originalPrice = sumArr(Object.values(spentCategoryMap));
    const { amountSpentByCategory, campaignDiscountAmount } = applyCampaignToCart(
      this.campaignHandler,
      cart,
      spentCategoryMap,
      campaign,
    );
    // get the total price after the campaign discount
    const totalPrice = sumArr(Object.values(amountSpentByCategory));
    // apply coupon to get coupon discount amount and final amount
    const { finalAmount, couponDiscountAmount } = applyCouponToAmount(
      this.couponHandler,
      totalPrice,
      coupon,
    );
    // apply the delivery cost
    const { totalCost } = this.deliveryCostCalculator.calculateFor(cart);
    // return the finalized cart
    return new FinalizedCart(
      cart.products,
      amountSpentByCategory,
      originalPrice,
      finalAmount + totalCost,
      totalCost,
      campaignDiscountAmount,
      couponDiscountAmount,
    );
  }

  /**
   * @param {Cart} cart
   * @param {Campaign} campaign
   * @returns {boolean}
   */
  doesCampaignApplyForCart(cart, campaign) {
    return this.campaignHandler.getDiscount(cart, campaign) !== null;
  }

  /**
   * @param {FinalizedCart} finalizedCart
   * @param {Coupon} coupon
   * @returns {boolean}
   */
  doesCouponApplyForCart(finalizedCart, coupon) {
    return this.couponHandler.getDiscount(finalizedCart.finalAmount, coupon) !== null;
  }

  /**
   * Create a default cart helper with th given deliveryCostCalculator options
   * @returns {CartHelper}
   */
  static createDefault({ costPerDelivery = 0, costPerProduct = 0, fixedCost = 0 } = {}) {
    return new CartHelper(
      new CampaignHandler(),
      new CouponHandler(),
      new DeliveryCostCalculator(costPerDelivery, costPerProduct, fixedCost),
    );
  }
}

module.exports = CartHelper;
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Wed Mar 13 2019 04:34:30 GMT+0300 (GMT+03:00) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>


</body>
</html>
